<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QuickDeals - Profile</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Roboto', Arial, sans-serif;
        }
        body {
            background-color: #f5f5f5;
            color: #333;
        }
        .app-container {
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }
        /* App Bar */
        .app-bar {
            background-color: #1976D2;
            color: white;
            padding: 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .app-title {
            font-weight: 700;
            font-size: 20px;
        }
        .app-bar-icon {
            color: white;
            cursor: pointer;
        }
        /* Profile Content */
        .profile-content {
            flex: 1;
            padding: 20px;
        }
        /* Profile Header */
        .profile-header {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-bottom: 25px;
        }
        .profile-image {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            object-fit: cover;
            border: 4px solid white;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            margin-bottom: 15px;
        }
        .profile-name {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 5px;
        }
        .profile-role {
            color: #666;
            font-size: 16px;
            margin-bottom: 15px;
        }
        .profile-stats {
            display: flex;
            justify-content: center;
            gap: 25px;
            margin-top: 15px;
        }
        .stat-item {
            text-align: center;
        }
        .stat-value {
            font-size: 18px;
            font-weight: 700;
            color: #1976D2;
        }
        .stat-label {
            font-size: 14px;
            color: #666;
        }
        /* Profile Sections */
        .profile-section {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .section-title {
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 15px;
            color: #333;
            display: flex;
            align-items: center;
        }
        .section-title .material-icons {
            margin-right: 10px;
            color: #1976D2;
        }
        /* Action Cards */
        .action-cards {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-top: 15px;
        }
        /* Temporary container to hold the dynamic list of action cards */
        #action-cards-container {
             display: contents; 
        }

        .action-card {
            background: #f9f9f9;
            border-radius: 10px;
            padding: 15px;
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }
        .action-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            background: #f0f7ff;
        }
        .action-icon {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: #1976D2;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 10px;
            font-size: 24px;
        }
        /* NEW: Style for the offers icon */
        #incoming-offers-card .action-icon {
             background: #FF5722; /* Orange color for offers */
        }

        .action-title {
            font-weight: 600;
            margin-bottom: 5px;
            font-size: 15px;
        }
        .action-desc {
            font-size: 13px;
            color: #666;
        }
        /* Personal Details */
        .detail-item {
            display: flex;
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 1px solid #eee;
        }
        .detail-item:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }
        .detail-icon {
            min-width: 40px;
            color: #1976D2;
        }
        .detail-content {
            flex: 1;
        }
        .detail-label {
            font-size: 14px;
            color: #666;
            margin-bottom: 3px;
        }
        .detail-value {
            font-size: 16px;
            font-weight: 500;
        }
        /* Bottom Navigation */
        .bottom-nav {
            display: flex;
            background-color: white;
            box-shadow: 0 -2px 4px rgba(0,0,0,0.1);
        }
        .nav-item {
            flex: 1;
            padding: 12px 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: #666;
            text-decoration: none;
            font-size: 12px;
            cursor: pointer;
        }
        .nav-item.active {
            color: #1976D2;
        }
        .nav-icon {
            font-size: 24px;
            margin-bottom: 4px;
        }
        /* Responsive */
        @media (max-width: 768px) {
            .action-cards {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <div class="app-bar">
            <span class="material-icons app-bar-icon" id="back-button">arrow_back</span>
            <span class="app-title">My Profile</span>
            <span class="material-icons app-bar-icon" id="edit-button">edit</span>
        </div>

        <div class="profile-content">
            <div class="profile-header">
                <img id="profile-image" src="https://via.placeholder.com/150/1976D2/FFFFFF?text=JD" class="profile-image" alt="Profile">
                <h2 id="profile-name" class="profile-name">Loading...</h2>
                <p id="profile-role" class="profile-role">Member • Seller</p>
                
                <div class="profile-stats">
                    <div class="stat-item">
                        <div id="products-count" class="stat-value">0</div>
                        <div class="stat-label">Products</div>
                    </div>
                    <div class="stat-item">
                        <div id="sales-count" class="stat-value">0</div>
                        <div class="stat-label">Sales</div>
                    </div>
                    <div class="stat-item">
                        <div id="rating-value" class="stat-value">0.0</div>
                        <div class="stat-label">Rating</div>
                    </div>
                </div>
            </div>

            <div class="profile-section">
                <h3 class="section-title"><span class="material-icons">flash_on</span>Quick Actions</h3>
                <div class="action-cards" id="action-cards-grid">
                    
                    <div id="action-cards-container">
                        <div class="action-card" id="add-product">
                            <div class="action-icon">
                                <span class="material-icons">add</span>
                            </div>
                            <div class="action-title">Add Product</div>
                            <div class="action-desc">List a new item for sale</div>
                        </div>
                        
                        <div class="action-card" id="my-bookings">
                            <div class="action-icon">
                                <span class="material-icons">event</span>
                            </div>
                            <div class="action-title">My Orders</div>
                            <div class="action-desc">View items you have purchased</div>
                        </div>
                        
                        <div class="action-card" id="my-products">
                            <div class="action-icon">
                                <span class="material-icons">inventory</span>
                            </div>
                            <div class="action-title">My Listings</div>
                            <div class="action-desc">Manage your products</div>
                        </div>
                        
                        <div class="action-card" id="account-settings">
                            <div class="action-icon">
                                <span class="material-icons">settings</span>
                            </div>
                            <div class="action-title">Settings</div>
                            <div class="action-desc">Manage your profile & preferences</div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="profile-section">
                <h3 class="section-title"><span class="material-icons">person</span>Personal Details</h3>
                
                <div class="detail-item">
                    <div class="detail-icon">
                        <span class="material-icons">person</span>
                    </div>
                    <div class="detail-content">
                        <div class="detail-label">Full Name</div>
                        <div id="detail-name" class="detail-value">Loading...</div>
                    </div>
                </div>
                
                <div class="detail-item">
                    <div class="detail-icon">
                        <span class="material-icons">email</span>
                    </div>
                    <div class="detail-content">
                        <div class="detail-label">Email</div>
                        <div id="detail-email" class="detail-value">Loading...</div>
                    </div>
                </div>
                
                <div class="detail-item">
                    <div class="detail-icon">
                        <span class="material-icons">phone</span>
                    </div>
                    <div class="detail-content">
                        <div class="detail-label">Phone</div>
                        <div id="detail-phone" class="detail-value">Loading...</div>
                    </div>
                </div>
                
                <div class="detail-item">
                    <div class="detail-icon">
                        <span class="material-icons">location_on</span>
                    </div>
                    <div class="detail-content">
                        <div class="detail-label">Address</div>
                        <div id="detail-address" class="detail-value">Loading...</div>
                    </div>
                </div>
                
                <div class="detail-item">
                    <div class="detail-icon">
                        <span class="material-icons">cake</span>
                    </div>
                    <div class="detail-content">
                        <div class="detail-label">Age</div>
                        <div id="detail-age" class="detail-value">Loading...</div>
                    </div>
                </div>
                
                <div class="detail-item">
                    <div class="detail-icon">
                        <span class="material-icons">calendar_today</span>
                    </div>
                    <div class="detail-content">
                        <div class="detail-label">Member Since</div>
                        <div id="detail-joined" class="detail-value">Loading...</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="bottom-nav">
            <a class="nav-item" id="home-nav" href="homepage.html">
                <span class="material-icons nav-icon">home</span>
                <span>Home</span>
            </a>
            <a class="nav-item" id="category-nav" href="categorypage.html">
                <span class="material-icons nav-icon">category</span>
                <span>Category</span>
            </a>
            <a class="nav-item" id="saved-nav" href="savedpage.html">
                <span class="material-icons nav-icon">shopping_cart</span>
                <span>Cart</span>
            </a>
            <a class="nav-item active" id="profile-nav" href="profilepage.html">
                <span class="material-icons nav-icon">person</span>
                <span>Profile</span>
            </a>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-app.js";
        import { getFirestore, collection, query, where, getDocs, doc, getDoc } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-firestore.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-auth.js";

        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDaDYNBIxppwwf3PtBKgz-14_6eVYQVRL0",
            authDomain: "quickpick-1523f.firebaseapp.com",
            projectId: "quickpick-1523f",
            storageBucket: "quickpick-1523f.appspot.com",
            messagingSenderId: "814647987706",
            appId: "1:814647987706:web:01595f83582fe3de0e2843",
            measurementId: "G-MMK0VWMY8T"
        };
        
        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        
        // Initialize services
        const db = getFirestore(app);
        const auth = getAuth(app);
        
        let currentUser = null;
        let userProductsCount = 0; // Global to store product count
        
        // DOM elements
        const profileName = document.getElementById('profile-name');
        const profileRole = document.getElementById('profile-role');
        const profileImage = document.getElementById('profile-image');
        const productsCountElement = document.getElementById('products-count');
        const salesCount = document.getElementById('sales-count');
        const ratingValue = document.getElementById('rating-value');
        const detailName = document.getElementById('detail-name');
        const detailEmail = document.getElementById('detail-email');
        const detailPhone = document.getElementById('detail-phone');
        const detailAddress = document.getElementById('detail-address');
        const detailAge = document.getElementById('detail-age');
        const detailJoined = document.getElementById('detail-joined');
        const actionCardsContainer = document.getElementById('action-cards-container');
        
        // Check authentication state
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = user;
                await loadUserData(user);
                await loadUserStats(user.uid);
                // Call displayActions after stats are loaded
                displayActions();
            } else {
                // Redirect to login if not authenticated
                alert("You must log in first!");
                window.location.href = "loginpage.html";
            }
        });
        
        // Load user data from Firestore users collection
        async function loadUserData(user) {
            try {
                const userDocRef = doc(db, 'users', user.uid);
                const userDoc = await getDoc(userDocRef);
                
                if (userDoc.exists()) {
                    const userData = userDoc.data();
                    
                    profileName.textContent = userData.name || "User";
                    detailName.textContent = userData.name || "Not set";
                    detailEmail.textContent = userData.email || user.email || "Not set";
                    detailPhone.textContent = userData.phone || "Not provided";
                    detailAddress.textContent = userData.address || "Not provided";
                    detailAge.textContent = userData.age ? `${userData.age} years` : "Not provided";
                    
                    // Set member since date
                    if (userData.created_at) {
                        const joinedDate = new Date(userData.created_at.seconds * 1000);
                        detailJoined.textContent = joinedDate.toLocaleDateString();
                    } else {
                        const joinedDate = new Date(user.metadata.creationTime);
                        detailJoined.textContent = joinedDate.toLocaleDateString();
                    }
                    
                    // Set profile image
                    if (userData.profile_photo_url) {
                        profileImage.src = userData.profile_photo_url;
                    } else if (user.photoURL) {
                        profileImage.src = user.photoURL;
                    } else {
                        const initials = userData.name ? userData.name.split(' ').map(n => n[0]).join('') : 'U';
                        profileImage.src = `https://via.placeholder.com/150/1976D2/FFFFFF?text=${initials}`;
                    }
                    
                    // Set role
                    if (userData.premium) {
                        profileRole.textContent = "Premium Member";
                    } else if (userData.verified) {
                        profileRole.textContent = "Verified Member";
                    } else {
                        profileRole.textContent = "Member";
                    }
                } else {
                    // Fallback to auth data if Firestore doc is missing
                    profileName.textContent = user.displayName || "User";
                    detailEmail.textContent = user.email || "Not set";
                    detailRole.textContent = "Member";
                }
            } catch (error) {
                console.error("Error loading user data:", error);
                // Simple fallback to ensure page loads
                profileName.textContent = "Error";
            }
        }
        
        // Load user stats (products count, sales, rating)
        async function loadUserStats(userId) {
            try {
                // Query products for the current user
                const productsQuery = query(
                    collection(db, 'products'),
                    where('userId', '==', userId)
                );
                
                const querySnapshot = await getDocs(productsQuery);
                
                let soldCount = 0;
                let totalRating = 0;
                let ratingCount = 0;
                
                querySnapshot.forEach((doc) => {
                    const product = doc.data();
                    
                    if (product.status === 'sold') {
                        soldCount++;
                    }
                    
                    // Add logic to aggregate ratings if structured that way
                    if (product.rating && product.ratingCount) {
                        totalRating += product.rating * product.ratingCount;
                        ratingCount += product.ratingCount;
                    }
                });
                
                // Store count globally to check if user is a seller
                userProductsCount = querySnapshot.size; 

                // Update stats display
                productsCountElement.textContent = userProductsCount.toString();
                salesCount.textContent = soldCount.toString();
                
                const avgRating = ratingCount > 0 ? (totalRating / ratingCount).toFixed(1) : "0.0";
                ratingValue.textContent = avgRating;
                
                // Update role text if they have products
                if (userProductsCount > 0) {
                     profileRole.textContent += " • Seller";
                }
                
            } catch (error) {
                console.error("Error loading user stats:", error);
                productsCountElement.textContent = "0";
                salesCount.textContent = "0";
                ratingValue.textContent = "0.0";
            }
        }
        
        // --- NEW FUNCTION: Dynamically display actions ---
        function displayActions() {
            // Base set of action cards (Orders, Add Product, Listings, Settings)
            const cardsHTML = [
                // Add Product
                `<div class="action-card" id="add-product">
                    <div class="action-icon">
                        <span class="material-icons">add</span>
                    </div>
                    <div class="action-title">Add Product</div>
                    <div class="action-desc">List a new item for sale</div>
                </div>`,
                // My Orders (Bookings they placed)
                `<div class="action-card" id="my-bookings">
                    <div class="action-icon">
                        <span class="material-icons">shopping_bag</span>
                    </div>
                    <div class="action-title">My Orders</div>
                    <div class="action-desc">View items you have purchased</div>
                </div>`,
                // My Listings (Products they published)
                `<div class="action-card" id="my-products">
                    <div class="action-icon">
                        <span class="material-icons">inventory</span>
                    </div>
                    <div class="action-title">My Listings</div>
                    <div class="action-desc">Manage your products</div>
                </div>`,
                // Account Settings
                `<div class="action-card" id="account-settings">
                    <div class="action-icon">
                        <span class="material-icons">settings</span>
                    </div>
                    <div class="action-title">Settings</div>
                    <div class="action-desc">Manage your profile & preferences</div>
                </div>`
            ];
            
            // --- CONDITIONALLY ADD INCOMING OFFERS CARD ---
            if (userProductsCount > 0) {
                 // Insert the new card as the second item (after 'Add Product')
                cardsHTML.splice(1, 0, 
                    `<div class="action-card" id="incoming-offers-card">
                        <div class="action-icon">
                            <span class="material-icons">local_offer</span>
                        </div>
                        <div class="action-title">Incoming Offers</div>
                        <div class="action-desc">View orders for your products</div>
                    </div>`
                );
            }
            
            // Render all cards
            actionCardsContainer.innerHTML = cardsHTML.join('');
            
            // Re-attach event listeners to the dynamically created elements
            attachActionListeners();
        }
        
        // --- NEW FUNCTION: Attach listeners after dynamic rendering ---
        function attachActionListeners() {
            // General Actions
            document.getElementById('add-product').addEventListener('click', () => window.location.href = "additem.html");
            document.getElementById('my-bookings').addEventListener('click', () => window.location.href = "mybookingpage.html");
            document.getElementById('my-products').addEventListener('click', () => window.location.href = "myproducts.html");
            document.getElementById('account-settings').addEventListener('click', () => alert("Redirecting to account settings..."));
            
            // Conditional Action
            const incomingOffersCard = document.getElementById('incoming-offers-card');
            if (incomingOffersCard) {
                incomingOffersCard.addEventListener('click', () => {
                    
                    window.location.href = "incomingoffers.html"; // Redirect to a seller-centric view
                });
            }
        }
        
        // Utility for Navigation (unchanged)
        document.getElementById('back-button').addEventListener('click', function() {
            window.history.back();
        });

        document.getElementById('edit-button').addEventListener('click', function() {
            window.location.href = "editprofile.html";  // Changed from alert to actual navigation
        });

        document.getElementById('category-nav').addEventListener('click', () => {
            window.location.href = "categorypage.html";
        });
        document.getElementById('home-nav').addEventListener('click', () => {
            window.location.href = "homepage.html";
        });
        document.getElementById('saved-nav').addEventListener('click', () => {
            window.location.href = "savedpage.html";
        });
        document.getElementById('profile-nav').addEventListener('click', () => {
            window.location.href = "profilepage.html";
        });
    </script>
</body>
</html>