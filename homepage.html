<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QuickPick - Nearby Products</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Roboto', Arial, sans-serif;
        }
        body {
            background-color: #f5f5f5;
            color: #333;
        }
        .app-container {
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }
        /* App Bar */
        .app-bar {
            background-color: #1976D2;
            color: white;
            padding: 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            position: sticky;
            top: 0;
            z-index: 100;
        }
        .app-title {
            font-weight: 700;
            font-size: 20px;
        }
        .app-bar-icon {
            color: white;
            cursor: pointer;
        }
        /* Content Area */
        .content-area {
            flex: 1;
            padding: 16px;
            padding-bottom: 70px; /* Space for bottom nav */
        }
        
        /* --- Radius Filter Container --- */
        .filter-container {
            display: flex;
            justify-content: flex-end;
            align-items: center;
            margin-bottom: 20px;
            padding: 10px 0;
        }

        .filter-container label {
            font-size: 14px;
            color: #555;
            margin-right: 10px;
            font-weight: 500;
        }

        #radius-select {
            padding: 8px 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            background-color: #fff;
            appearance: none; 
            cursor: pointer;
            outline: none;
            color: #1976D2;
            font-weight: 500;
        }
        
        .section-title {
            font-size: 18px;
            font-weight: 500;
            margin-bottom: 16px;
            color: #333;
        }
        
        /* === ENHANCED CARD STYLE === */
        .product-card {
            background-color: white;
            border-bottom: 1px solid #eee; 
            margin-bottom: 0;
            padding: 15px 0;
            overflow: hidden;
            display: flex; 
            align-items: flex-start;
            text-decoration: none;
            color: inherit;
        }
        
        .product-card:last-child {
            border-bottom: none;
        }

        .product-image {
            width: 120px; /* INCREASED SIZE */
            height: 120px; /* INCREASED SIZE */
            object-fit: cover;
            border-radius: 4px;
            flex-shrink: 0;
        }
        
        .product-details {
            padding: 0 0 0 15px;
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            height: 120px; /* Match image height for vertical alignment */
        }
        
        .product-top-info {
            display: flex;
            flex-direction: column;
        }

        .product-name {
            font-weight: 500; /* Slightly bolder title */
            font-size: 17px; /* Slightly larger title */
            margin-bottom: 4px;
            line-height: 1.3;
            /* Max two lines for long titles */
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
        
        .product-location-line {
            display: flex;
            align-items: center;
            color: #666;
            font-size: 13px;
            margin-bottom: 4px;
        }
        
        .product-location-line span {
            margin-right: 15px;
            display: flex;
            align-items: center;
        }

        .location-icon {
            font-size: 16px;
            margin-right: 4px;
            color: #999; 
        }
        
        .product-price {
            font-weight: 700;
            color: #FF5722; /* Orange color for price */
            font-size: 18px; /* Larger price */
            margin-top: 5px;
        }
        /* === END ENHANCED CARD STYLE === */


        /* Loading and Error States */
        .loading-container, .error-container, .location-prompt {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 40px 20px;
            text-align: center;
        }
        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #1976D2;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 16px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .location-button {
            margin-top: 16px;
            padding: 10px 20px;
            background-color: #1976D2;
            color: white;
            border: none;
            border-radius: 4px;
            font-weight: 500;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        /* Bottom Navigation */
        .bottom-nav {
            position: fixed;
            left: 0;
            right: 0;
            bottom: 0;
            display: flex;
            background-color: white;
            box-shadow: 0 -2px 4px rgba(0,0,0,0.1);
            z-index: 100;
            height: 60px;
        }
        .nav-item {
            flex: 1;
            padding: 8px 0 0 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: #666;
            text-decoration: none;
            font-size: 12px;
            cursor: pointer;
            height: 100%;
            transition: color 0.2s;
        }
        .nav-item.active {
            color: #1976D2;
        }
        .nav-icon {
            font-size: 24px;
            margin-bottom: 2px;
        }
    </style>
</head>
<body>
    <div class="app-container">
        <div class="app-bar">
            <span class="material-icons app-bar-icon" id="menu-button">menu</span>
            <span class="app-title">QuickPick</span>
            <span class="material-icons app-bar-icon" id="search-button">search</span>
        </div>

        <div class="content-area" id="content-area">
            <div class="filter-container">
                <label for="radius-select">Radius:</label>
                <select id="radius-select">
                    <option value="10">10 km</option>
                    <option value="20">20 km</option>
                    <option value="30">30 km</option>
                    <option value="60" selected>60 km</option>
                    <option value="100">100 km</option>
                    <option value="200">200 km</option>
                </select>
            </div>
            
            <div class="loading-container" id="loading-container">
                <div class="loading-spinner"></div>
                <p>Finding products near you...</p>
            </div>
            
            <div id="products-list-container">
                </div>
        </div>

        <div class="bottom-nav">
            <a class="nav-item active" id="home-nav" href="homepage.html">
                <span class="material-icons nav-icon">home</span>
                <span>Home</span>
            </a>
            <a class="nav-item" id="category-nav" href="categorypage.html">
                <span class="material-icons nav-icon">category</span>
                <span>Category</span>
            </a>
            <a class="nav-item" id="sell-nav" href="additem.html">
                <span class="material-icons nav-icon">add_box</span>
                <span>Sell</span>
            </a>
            <a class="nav-item" id="saved-nav" href="savedpage.html">
                <span class="material-icons nav-icon">shopping_cart</span>
                <span>Cart</span>
            </a>
            <a class="nav-item" id="profile-nav" href="profilepage.html">
                <span class="material-icons nav-icon">person</span>
                <span>Profile</span>
            </a>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>

    <script>
        // =========================================================================
        // Firebase Configuration & Initialization
        // =========================================================================
        const firebaseConfig = {
            apiKey: "AIzaSyDaDYNBIxppwwf3PtBKgz-14_6eVYQVRL0",
            authDomain: "quickpick-1523f.firebaseapp.com",
            projectId: "quickpick-1523f",
            storageBucket: "quickpick-1523f.appspot.com",
            messagingSenderId: "814647987706",
            appId: "1:814647987706:web:01595f83582fe3de0e2843",
            measurementId: "G-MMK0VWMY8T"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // =========================================================================
        // Global Variables
        // =========================================================================
        const loadingContainer = document.getElementById('loading-container');
        const radiusSelect = document.getElementById('radius-select');
        const productsListContainer = document.getElementById('products-list-container');

        let userLocation = null;
        let currentRadius = 60; // Default radius in km

        // =========================================================================
        // Geo-Filtering Logic
        // =========================================================================

        // Haversine formula to calculate distance between two lat/lng points
        function getDistance(lat1, lon1, lat2, lon2) {
            const R = 6371; // Radius of Earth in kilometers
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                        Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                        Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            const d = R * c; // Distance in km
            return d;
        }

        /**
         * Extracts numeric latitude and longitude from the product data, 
         * handling GeoPoint ('geo') and the non-standard string ('location').
         */
        function extractCoordinates(productData) {
            let lat = null;
            let lng = null;

            // 1. Check for the standard GeoPoint field (named 'geo')
            if (productData.geo && typeof productData.geo.latitude === 'number' && typeof productData.geo.longitude === 'number') {
                lat = productData.geo.latitude;
                lng = productData.geo.longitude;
            } 
            // 2. Check for the non-standard 'location' string (e.g., "9.8895 N, 78.0546 E")
            else if (productData.location && typeof productData.location === 'string') {
                const parts = productData.location.split(',');
                if (parts.length >= 2) {
                    lat = parseFloat(parts[0].replace(/[^0-9.-]/g, ''));
                    lng = parseFloat(parts[1].replace(/[^0-9.-]/g, ''));
                }
            }
            
            // Validate that we got numbers and return
            if (!isNaN(lat) && !isNaN(lng)) {
                return { lat, lng };
            }
            return null;
        }

        // Fetch products from Firebase and filter by distance
        async function fetchNearbyProducts(location, radius) {
            productsListContainer.innerHTML = '';
            loadingContainer.style.display = 'flex';

            try {
                const productsCollection = await db.collection('products').get();
                const productsList = [];
                
                productsCollection.forEach(doc => {
                    const productData = doc.data();
                    const productCoords = extractCoordinates(productData); 
                    
                    // Only process products that are 'available' and have valid coordinates
                    if (productData.status === 'available' && productCoords) {
                        
                        const distance = getDistance(
                            location.lat,
                            location.lng,
                            productCoords.lat,
                            productCoords.lng
                        );

                        // Filter products: distance MUST be LESS THAN OR EQUAL TO the selected radius
                        if (distance <= radius) {
                            productsList.push({
                                id: doc.id,
                                ...productData,
                                distance: distance.toFixed(1) // Round to one decimal place
                            });
                        }
                    }
                });

                loadingContainer.style.display = 'none';

                if (productsList.length === 0) {
                    showNoProductsFound(radius);
                } else {
                    displayProducts(productsList, radius);
                }

            } catch (error) {
                console.error("Error fetching products: ", error);
                loadingContainer.style.display = 'none';
                showError("Failed to fetch products. Please check your console for details.");
            }
        }

        // =========================================================================
        // UI Rendering Functions (MODIFIED)
        // =========================================================================

        // Helper function for price formatting (e.g., 5600.00 -> 5,600.00)
        function formatPrice(price) {
            // Use en-IN locale for Indian Rupee format (commas for thousands)
            return parseFloat(price).toLocaleString('en-IN', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        }

        // Display products
        function displayProducts(products, radius) {
            productsListContainer.innerHTML = `
                <div id="products-list"></div>
            `;
            
            const productsList = document.getElementById('products-list');
            
            products.forEach(product => {
                const productCard = document.createElement('a');
                productCard.className = 'product-card';
                productCard.href = `productdetail.html?id=${product.id}`; 
                
                // Use a default image if none is available
                const imageUrl = product.images && product.images.length > 0 ? product.images[0] : 'https://via.placeholder.com/120x120?text=QuickPick';

                // Ensure location_text is capitalized for better display
                const locationText = product.location_text || '';
                const displayCategory = product.category ? product.category.charAt(0).toUpperCase() + product.category.slice(1) : 'General';
                
                // The structure is now: Image | Name, Location, Price, Category/Distance
                productCard.innerHTML = `
                    <img src="${imageUrl}" alt="${product.title}" class="product-image">
                    <div class="product-details">
                        <div class="product-top-info">
                            <h3 class="product-name">${product.title}</h3>
                            
                            <div class="product-location-line">
                                <span class="location-text">
                                    <span class="material-icons location-icon">location_on</span>
                                    ${locationText || product.distance + ' km away'}
                                </span>
                                <span class="category-text">
                                    ${displayCategory}
                                </span>
                            </div>
                        </div>

                        <span class="product-price">â‚¹${formatPrice(product.price)}</span>
                    </div>
                `;
                productsList.appendChild(productCard);
            });
        }

        function showNoProductsFound(radius) {
            productsListContainer.innerHTML = `
                <div class="error-container">
                    <span class="material-icons" style="font-size: 48px; color: #666; margin-bottom: 16px;">sentiment_dissatisfied</span>
                    <p>No available products found within your **${radius} km** radius.</p>
                    <p>Try increasing the radius using the filter above!</p>
                </div>
            `;
        }

        function showError(message) {
            productsListContainer.innerHTML = `
                <div class="error-container">
                    <span class="material-icons" style="font-size: 48px; color: #f44336; margin-bottom: 16px;">error_outline</span>
                    <p>${message}</p>
                </div>
            `;
        }

        function showLocationError() {
            productsListContainer.innerHTML = `
                <div class="error-container">
                    <span class="material-icons" style="font-size: 48px; color: #f44336; margin-bottom: 16px;">location_off</span>
                    <p>We need your location to show nearby products.</p>
                    <button class="location-button" onclick="initApp()">
                        <span class="material-icons">my_location</span>
                        Enable Location
                    </button>
                </div>
            `;
        }

        function showLocationNotSupported() {
            productsListContainer.innerHTML = `
                <div class="error-container">
                    <span class="material-icons" style="font-size: 48px; color: #f44336; margin-bottom: 16px;">error</span>
                    <p>Geolocation is not supported by your browser.</p>
                    <p>This app requires location services.</p>
                </div>
            `;
        }

        // =========================================================================
        // Initialization & Event Handlers
        // =========================================================================

        function initApp() {
            if (navigator.geolocation) {
                productsListContainer.innerHTML = '';
                loadingContainer.style.display = 'flex';

                navigator.geolocation.getCurrentPosition(
                    position => {
                        userLocation = {
                            lat: position.coords.latitude,
                            lng: position.coords.longitude
                        };
                        fetchNearbyProducts(userLocation, currentRadius);
                    },
                    error => {
                        loadingContainer.style.display = 'none';
                        showLocationError();
                    },
                    { enableHighAccuracy: true, timeout: 10000, maximumAge: 60000 }
                );
            } else {
                loadingContainer.style.display = 'none';
                showLocationNotSupported();
            }
        }

        radiusSelect.addEventListener('change', function() {
            const newRadius = parseInt(this.value);
            currentRadius = newRadius;
            
            if (userLocation) {
                fetchNearbyProducts(userLocation, currentRadius);
            } else {
                initApp();
            }
        });

        // Navigation handlers
        document.getElementById('category-nav').addEventListener('click', (e) => { e.preventDefault(); window.location.href = "categorypage.html"; });
        document.getElementById('home-nav').addEventListener('click', (e) => { e.preventDefault(); window.location.href = "homepage.html"; });
        document.getElementById('saved-nav').addEventListener('click', (e) => { e.preventDefault(); window.location.href = "savedpage.html"; });
        document.getElementById('profile-nav').addEventListener('click', (e) => { e.preventDefault(); window.location.href = "profilepage.html"; });
        document.getElementById('sell-nav').addEventListener('click', (e) => { e.preventDefault(); window.location.href = "additem.html"; });

        // Initialize the app
        initApp();
    </script>
</body>
</html>